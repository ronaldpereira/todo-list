#!/usr/bin/env node
'use strict';

var _getIterator2 = require('babel-runtime/core-js/get-iterator');

var _getIterator3 = _interopRequireDefault(_getIterator2);

var _toArray2 = require('babel-runtime/helpers/toArray');

var _toArray3 = _interopRequireDefault(_toArray2);

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _toConsumableArray2 = require('babel-runtime/helpers/toConsumableArray');

var _toConsumableArray3 = _interopRequireDefault(_toConsumableArray2);

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _slicedToArray2 = require('babel-runtime/helpers/slicedToArray');

var _slicedToArray3 = _interopRequireDefault(_slicedToArray2);

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var sync = function () {
  var _ref = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee5(token) {
    var _this = this;

    var start, rawPath, stopDeployment, isValidRepo, repo, gitParts, searchMessage, gitRef, _gitRef, deploymentType, hasPackage, hasDockerfile, isStatic, _ref2, _ref3, _ref6, _ref6$pkg, _ref6$pkg$now, pkgConfig, now, pkgEnv, envs, secrets, findSecret, env_, env, url, elapsed, startU, complete;

    return _regenerator2.default.wrap(function _callee5$(_context5) {
      while (1) {
        switch (_context5.prev = _context5.next) {
          case 0:
            start = Date.now();
            rawPath = argv._[0];

            stopDeployment = function stopDeployment(msg) {
              (0, _error.error)(msg);
              process.exit(1);
            };

            isValidRepo = (0, _git.isRepoPath)(rawPath);
            _context5.prev = 4;
            _context5.next = 7;
            return _fsPromise2.default.stat(path);

          case 7:
            _context5.next = 26;
            break;

          case 9:
            _context5.prev = 9;
            _context5.t0 = _context5['catch'](4);
            repo = void 0;

            if (!(isValidRepo && isValidRepo !== 'no-valid-url')) {
              _context5.next = 25;
              break;
            }

            gitParts = (0, _git.gitPathParts)(rawPath);

            (0, _assign2.default)(gitRepo, gitParts);

            searchMessage = setTimeout(function () {
              console.log('> Didn\'t find directory. Searching on ' + gitRepo.type + '...');
            }, 500);
            _context5.prev = 16;
            _context5.next = 19;
            return (0, _git.fromGit)(rawPath, debug);

          case 19:
            repo = _context5.sent;
            _context5.next = 24;
            break;

          case 22:
            _context5.prev = 22;
            _context5.t1 = _context5['catch'](16);

          case 24:

            clearTimeout(searchMessage);

          case 25:

            if (repo) {
              // Tell now which directory to deploy
              path = repo.path;

              // Set global variable for deleting tmp dir later
              // once the deployment has finished
              (0, _assign2.default)(gitRepo, repo);
            } else if (isValidRepo === 'no-valid-url') {
              stopDeployment('This URL is neither a valid repository from GitHub, nor from GitLab.');
            } else if (isValidRepo) {
              gitRef = gitRepo.ref ? 'with "' + _chalk2.default.bold(gitRepo.ref) + '" ' : '';

              stopDeployment('There\'s no repository named "' + _chalk2.default.bold(gitRepo.main) + '" ' + gitRef + 'on ' + gitRepo.type);
            } else {
              stopDeployment('Could not read directory ' + _chalk2.default.bold(path));
            }

          case 26:
            _context5.next = 28;
            return (0, _checkPath2.default)(path);

          case 28:

            if (!quiet) {
              if (gitRepo.main) {
                _gitRef = gitRepo.ref ? ' at "' + _chalk2.default.bold(gitRepo.ref) + '" ' : '';

                console.log('> Deploying ' + gitRepo.type + ' repository "' + _chalk2.default.bold(gitRepo.main) + '"' + _gitRef);
              } else {
                console.log('> Deploying ' + _chalk2.default.bold((0, _toHumanPath2.default)(path)));
              }
            }

            deploymentType = void 0;
            hasPackage = void 0;
            hasDockerfile = void 0;
            isStatic = void 0;

            if (!argv.docker) {
              _context5.next = 38;
              break;
            }

            if (debug) {
              console.log('> [debug] Forcing `deploymentType` = `docker`');
            }

            deploymentType = 'docker';
            _context5.next = 90;
            break;

          case 38:
            if (!argv.npm) {
              _context5.next = 42;
              break;
            }

            deploymentType = 'npm';
            _context5.next = 90;
            break;

          case 42:
            if (!argv.static) {
              _context5.next = 48;
              break;
            }

            if (debug) {
              console.log('> [debug] Forcing static deployment');
            }

            deploymentType = 'npm';
            isStatic = true;
            _context5.next = 90;
            break;

          case 48:
            _context5.prev = 48;
            _context5.next = 51;
            return _fsPromise2.default.stat((0, _path.resolve)(path, 'package.json'));

          case 51:
            _context5.next = 56;
            break;

          case 53:
            _context5.prev = 53;
            _context5.t2 = _context5['catch'](48);

            hasPackage = true;

          case 56:
            _context5.t3 = _promise2.default;
            _context5.next = 59;
            return (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee() {
              return _regenerator2.default.wrap(function _callee$(_context) {
                while (1) {
                  switch (_context.prev = _context.next) {
                    case 0:
                      _context.prev = 0;
                      _context.next = 3;
                      return _fsPromise2.default.stat((0, _path.resolve)(path, 'package.json'));

                    case 3:
                      _context.next = 8;
                      break;

                    case 5:
                      _context.prev = 5;
                      _context.t0 = _context['catch'](0);
                      return _context.abrupt('return', false);

                    case 8:
                      return _context.abrupt('return', true);

                    case 9:
                    case 'end':
                      return _context.stop();
                  }
                }
              }, _callee, _this, [[0, 5]]);
            }))();

          case 59:
            _context5.t4 = _context5.sent;
            _context5.next = 62;
            return (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee2() {
              return _regenerator2.default.wrap(function _callee2$(_context2) {
                while (1) {
                  switch (_context2.prev = _context2.next) {
                    case 0:
                      _context2.prev = 0;
                      _context2.next = 3;
                      return _fsPromise2.default.stat((0, _path.resolve)(path, 'Dockerfile'));

                    case 3:
                      _context2.next = 8;
                      break;

                    case 5:
                      _context2.prev = 5;
                      _context2.t0 = _context2['catch'](0);
                      return _context2.abrupt('return', false);

                    case 8:
                      return _context2.abrupt('return', true);

                    case 9:
                    case 'end':
                      return _context2.stop();
                  }
                }
              }, _callee2, _this, [[0, 5]]);
            }))();

          case 62:
            _context5.t5 = _context5.sent;
            _context5.t6 = [_context5.t4, _context5.t5];
            _context5.next = 66;
            return _context5.t3.all.call(_context5.t3, _context5.t6);

          case 66:
            _ref2 = _context5.sent;
            _ref3 = (0, _slicedToArray3.default)(_ref2, 2);
            hasPackage = _ref3[0];
            hasDockerfile = _ref3[1];

            if (!(hasPackage && hasDockerfile)) {
              _context5.next = 89;
              break;
            }

            if (debug) {
              console.log('[debug] multiple manifests found, disambiguating');
            }

            if (!isTTY) {
              _context5.next = 86;
              break;
            }

            _context5.prev = 73;

            console.log('> Two manifests found. Press [' + _chalk2.default.bold('n') + '] to deploy or re-run with --flag');
            _context5.next = 77;
            return (0, _promptOptions2.default)([['npm', _chalk2.default.bold('package.json') + '\t' + _chalk2.default.gray('   --npm') + ' '], ['docker', _chalk2.default.bold('Dockerfile') + '\t' + _chalk2.default.gray('--docker') + ' ']]);

          case 77:
            deploymentType = _context5.sent;
            _context5.next = 84;
            break;

          case 80:
            _context5.prev = 80;
            _context5.t7 = _context5['catch'](73);

            (0, _error.error)(_context5.t7.message);
            process.exit(1);

          case 84:
            _context5.next = 87;
            break;

          case 86:
            (0, _error.error)('Ambiguous deployment (`package.json` and `Dockerfile` found). ' + 'Please supply `--npm` or `--docker` to disambiguate.');

          case 87:
            _context5.next = 90;
            break;

          case 89:
            if (hasPackage) {
              if (debug) {
                console.log('> [debug] `package.json` found, assuming `deploymentType` = `npm`');
              }

              deploymentType = 'npm';
            } else if (hasDockerfile) {
              if (debug) {
                console.log('> [debug] `Dockerfile` found, assuming `deploymentType` = `docker`');
              }

              deploymentType = 'docker';
            } else {
              if (debug) {
                console.log('> [debug] No manifest files found, assuming static deployment');
              }

              isStatic = true;
            }

          case 90:
            _context5.next = 92;
            return (0, _readMetadata2.default)(path, {
              deploymentType: deploymentType,
              deploymentName: deploymentName,
              isStatic: isStatic,
              quiet: true
            });

          case 92:
            _ref6 = _context5.sent;
            _ref6$pkg = _ref6.pkg;
            _ref6$pkg = _ref6$pkg === undefined ? {} : _ref6$pkg;
            _ref6$pkg$now = _ref6$pkg.now, pkgConfig = _ref6$pkg$now === undefined ? {} : _ref6$pkg$now;
            now = new _lib2.default(apiUrl, token, { debug: debug });

            // Merge `now.env` from package.json with `-e` arguments.

            pkgEnv = pkgConfig.env;
            envs = [].concat((0, _toConsumableArray3.default)((0, _keys2.default)(pkgEnv || {}).map(function (k) {
              return k + '=' + pkgEnv[k];
            })), (0, _toConsumableArray3.default)([].concat(argv.env || [])));
            secrets = void 0;

            findSecret = function () {
              var _ref7 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee3(uidOrName) {
                return _regenerator2.default.wrap(function _callee3$(_context3) {
                  while (1) {
                    switch (_context3.prev = _context3.next) {
                      case 0:
                        if (secrets) {
                          _context3.next = 4;
                          break;
                        }

                        _context3.next = 3;
                        return now.listSecrets();

                      case 3:
                        secrets = _context3.sent;

                      case 4:
                        return _context3.abrupt('return', secrets.filter(function (secret) {
                          return secret.name === uidOrName || secret.uid === uidOrName;
                        }));

                      case 5:
                      case 'end':
                        return _context3.stop();
                    }
                  }
                }, _callee3, _this);
              }));

              return function findSecret(_x2) {
                return _ref7.apply(this, arguments);
              };
            }();

            _context5.next = 103;
            return _promise2.default.all(envs.map(function () {
              var _ref8 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee4(kv) {
                var _kv$split, _kv$split2, key, rest, val, uidOrName, _secrets;

                return _regenerator2.default.wrap(function _callee4$(_context4) {
                  while (1) {
                    switch (_context4.prev = _context4.next) {
                      case 0:
                        if (!(typeof kv !== 'string')) {
                          _context4.next = 3;
                          break;
                        }

                        (0, _error.error)('Env key and value missing');
                        return _context4.abrupt('return', process.exit(1));

                      case 3:
                        _kv$split = kv.split('='), _kv$split2 = (0, _toArray3.default)(_kv$split), key = _kv$split2[0], rest = _kv$split2.slice(1);
                        val = void 0;


                        if (rest.length > 0) {
                          val = rest.join('=');
                        }

                        if (!/[^A-z0-9_]/i.test(key)) {
                          _context4.next = 9;
                          break;
                        }

                        (0, _error.error)('Invalid ' + _chalk2.default.dim('-e') + ' key ' + _chalk2.default.bold('"' + _chalk2.default.bold(key) + '"') + '. Only letters, digits and underscores are allowed.');
                        return _context4.abrupt('return', process.exit(1));

                      case 9:
                        if (key) {
                          _context4.next = 12;
                          break;
                        }

                        (0, _error.error)('Invalid env option ' + _chalk2.default.bold('"' + kv + '"'));
                        return _context4.abrupt('return', process.exit(1));

                      case 12:
                        if (!(val === undefined)) {
                          _context4.next = 20;
                          break;
                        }

                        if (!(key in process.env)) {
                          _context4.next = 18;
                          break;
                        }

                        console.log('> Reading ' + _chalk2.default.bold('"' + _chalk2.default.bold(key) + '"') + ' from your env (as no value was specified)');
                        // escape value if it begins with @
                        val = process.env[key].replace(/^\@/, '\\@');
                        _context4.next = 20;
                        break;

                      case 18:
                        (0, _error.error)('No value specified for env ' + _chalk2.default.bold('"' + _chalk2.default.bold(key) + '"') + ' and it was not found in your env.');
                        return _context4.abrupt('return', process.exit(1));

                      case 20:
                        if (!(val[0] === '@')) {
                          _context4.next = 34;
                          break;
                        }

                        uidOrName = val.substr(1);
                        _context4.next = 24;
                        return findSecret(uidOrName);

                      case 24:
                        _secrets = _context4.sent;

                        if (!(_secrets.length === 0)) {
                          _context4.next = 30;
                          break;
                        }

                        if (uidOrName === '') {
                          (0, _error.error)('Empty reference provided for env key ' + _chalk2.default.bold('"' + _chalk2.default.bold(key) + '"'));
                        } else {
                          (0, _error.error)('No secret found by uid or name ' + _chalk2.default.bold('"' + uidOrName + '"'));
                        }
                        return _context4.abrupt('return', process.exit(1));

                      case 30:
                        if (!(_secrets.length > 1)) {
                          _context4.next = 33;
                          break;
                        }

                        (0, _error.error)('Ambiguous secret ' + _chalk2.default.bold('"' + uidOrName + '"') + ' (matches ' + _chalk2.default.bold(_secrets.length) + ' secrets)');
                        return _context4.abrupt('return', process.exit(1));

                      case 33:

                        val = { uid: _secrets[0].uid };

                      case 34:
                        return _context4.abrupt('return', [key, typeof val === 'string' ? val.replace(/^\\@/, '@') : val]);

                      case 35:
                      case 'end':
                        return _context4.stop();
                    }
                  }
                }, _callee4, _this);
              }));

              return function (_x3) {
                return _ref8.apply(this, arguments);
              };
            }()));

          case 103:
            env_ = _context5.sent;
            env = {};

            env_.filter(function (v) {
              return Boolean(v);
            }).forEach(function (_ref9) {
              var _ref10 = (0, _slicedToArray3.default)(_ref9, 2),
                  key = _ref10[0],
                  val = _ref10[1];

              if (key in env) {
                console.log('> ' + _chalk2.default.yellow('NOTE:') + ' Overriding duplicate env key ' + _chalk2.default.bold('"' + key + '"'));
              }

              env[key] = val;
            });

            _context5.prev = 106;
            _context5.next = 109;
            return now.create(path, {
              env: env,
              deploymentType: deploymentType,
              deploymentName: deploymentName,
              forceNew: forceNew,
              forceSync: forceSync,
              forwardNpm: alwaysForwardNpm || forwardNpm,
              quiet: quiet,
              wantsPublic: wantsPublic,
              isStatic: isStatic
            });

          case 109:
            _context5.next = 116;
            break;

          case 111:
            _context5.prev = 111;
            _context5.t8 = _context5['catch'](106);

            if (debug) {
              console.log('> [debug] error: ' + _context5.t8.stack);
            }

            (0, _error.handleError)(_context5.t8);
            process.exit(1);

          case 116:
            url = now.url;
            elapsed = (0, _ms2.default)(new Date() - start);

            if (!isTTY) {
              _context5.next = 134;
              break;
            }

            if (!clipboard) {
              _context5.next = 131;
              break;
            }

            _context5.prev = 120;
            _context5.next = 123;
            return (0, _copy2.default)(url);

          case 123:
            console.log(_chalk2.default.cyan('> Ready!') + ' ' + _chalk2.default.bold(url) + ' (copied to clipboard) [' + elapsed + ']');
            _context5.next = 129;
            break;

          case 126:
            _context5.prev = 126;
            _context5.t9 = _context5['catch'](120);

            console.log(_chalk2.default.cyan('> Ready!') + ' ' + _chalk2.default.bold(url) + ' [' + elapsed + ']');

          case 129:
            _context5.next = 132;
            break;

          case 131:
            console.log('> ' + url + ' [' + elapsed + ']');

          case 132:
            _context5.next = 135;
            break;

          case 134:
            process.stdout.write(url);

          case 135:
            startU = new Date();

            complete = function complete() {
              if (!quiet) {
                var elapsedU = (0, _ms2.default)(new Date() - startU);
                console.log('> Sync complete (' + (0, _bytes2.default)(now.syncAmount) + ') [' + elapsedU + '] ');
                console.log('> Initializing‚Ä¶');
              }

              // close http2 agent
              now.close();

              // show build logs
              printLogs(now.host, token);
            };

            if (now.syncAmount) {
              (function () {
                var bar = new _progress2.default('> Upload [:bar] :percent :etas', {
                  width: 20,
                  complete: '=',
                  incomplete: '',
                  total: now.syncAmount
                });

                now.upload();

                now.on('upload', function (_ref11) {
                  var names = _ref11.names,
                      data = _ref11.data;

                  var amount = data.length;
                  if (debug) {
                    console.log('> [debug] Uploaded: ' + names.join(' ') + ' (' + (0, _bytes2.default)(data.length) + ')');
                  }
                  bar.tick(amount);
                });

                now.on('complete', complete);

                now.on('error', function (err) {
                  (0, _error.error)('Upload failed');
                  (0, _error.handleError)(err);
                  process.exit(1);
                });
              })();
            } else {
              if (!quiet) {
                console.log('> Initializing\u2026');
              }

              // close http2 agent
              now.close();

              // show build logs
              printLogs(now.host, token);
            }

          case 138:
          case 'end':
            return _context5.stop();
        }
      }
    }, _callee5, this, [[4, 9], [16, 22], [48, 53], [73, 80], [106, 111], [120, 126]]);
  }));

  return function sync(_x) {
    return _ref.apply(this, arguments);
  };
}();

var _path = require('path');

var _progress = require('progress');

var _progress2 = _interopRequireDefault(_progress);

var _fsPromise = require('fs-promise');

var _fsPromise2 = _interopRequireDefault(_fsPromise);

var _bytes = require('bytes');

var _bytes2 = _interopRequireDefault(_bytes);

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _minimist = require('minimist');

var _minimist2 = _interopRequireDefault(_minimist);

var _ms = require('ms');

var _ms2 = _interopRequireDefault(_ms);

var _psl = require('psl');

var _psl2 = _interopRequireDefault(_psl);

var _copy = require('../lib/copy');

var _copy2 = _interopRequireDefault(_copy);

var _login = require('../lib/login');

var _login2 = _interopRequireDefault(_login);

var _cfg = require('../lib/cfg');

var cfg = _interopRequireWildcard(_cfg);

var _package = require('../../package');

var _buildLogger = require('../lib/build-logger');

var _buildLogger2 = _interopRequireDefault(_buildLogger);

var _lib = require('../lib');

var _lib2 = _interopRequireDefault(_lib);

var _toHumanPath = require('../lib/utils/to-human-path');

var _toHumanPath2 = _interopRequireDefault(_toHumanPath);

var _promptOptions = require('../lib/utils/prompt-options');

var _promptOptions2 = _interopRequireDefault(_promptOptions);

var _error = require('../lib/error');

var _git = require('../lib/git');

var _readMetadata = require('../lib/read-metadata');

var _readMetadata2 = _interopRequireDefault(_readMetadata);

var _checkPath = require('../lib/utils/check-path');

var _checkPath2 = _interopRequireDefault(_checkPath);

var _alias = require('../lib/alias');

var _alias2 = _interopRequireDefault(_alias);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// Packages
var argv = (0, _minimist2.default)(process.argv.slice(2), {
  string: ['config', 'token', 'name', 'alias'],
  boolean: ['help', 'version', 'debug', 'force', 'login', 'no-clipboard', 'forward-npm', 'docker', 'npm', 'static'],
  alias: {
    env: 'e',
    help: 'h',
    config: 'c',
    debug: 'd',
    version: 'v',
    force: 'f',
    token: 't',
    forceSync: 'F',
    login: 'L',
    public: 'p',
    'no-clipboard': 'C',
    'forward-npm': 'N',
    name: 'n',
    alias: 'a'
  }
});

// Ours


// Native


var help = function help() {
  console.log('\n  ' + _chalk2.default.bold('ùö´ now') + ' [options] <command | path>\n\n  ' + _chalk2.default.dim('Commands:') + '\n\n    deploy       [path]       Performs a deployment ' + _chalk2.default.bold('(default)') + '\n    ls | list    [app]        List deployments\n    rm | remove  [id]         Remove a deployment\n    ln | alias   [id] [url]   Configures aliases for deployments\n    domains      [name]       Manages your domain names\n    certs        [cmd]        Manages your SSL certificates\n    secrets      [name]       Manages your secret environment variables\n    dns          [name]       Manages your DNS records\n    help         [cmd]        Displays complete help for [cmd]\n\n  ' + _chalk2.default.dim('Options:') + '\n\n    -h, --help                Output usage information\n    -v, --version             Output the version number\n    -n, --name                Set the name of the deployment\n    -c ' + _chalk2.default.underline('FILE') + ', --config=' + _chalk2.default.underline('FILE') + '    Config file\n    -d, --debug               Debug mode [off]\n    -f, --force               Force a new deployment even if nothing has changed\n    -t ' + _chalk2.default.underline('TOKEN') + ', --token=' + _chalk2.default.underline('TOKEN') + '   Login token\n    -L, --login               Configure login\n    -p, --public              Deployment is public (' + _chalk2.default.dim('`/_src`') + ' is exposed) [on for oss, off for premium]\n    -e, --env                 Include an env var (e.g.: ' + _chalk2.default.dim('`-e KEY=value`') + '). Can appear many times.\n    -C, --no-clipboard        Do not attempt to copy URL to clipboard\n    -N, --forward-npm         Forward login information to install private NPM modules\n    -a, --alias               Assign an alias to the deployment\n\n  ' + _chalk2.default.dim('Enforcable Types (when both package.json and Dockerfile exist):') + '\n\n    --npm                     Node.js application\n    --docker                  Docker container\n    --static                  Static file hosting\n\n  ' + _chalk2.default.dim('Examples:') + '\n\n  ' + _chalk2.default.gray('‚Äì') + ' Deploys the current directory\n\n    ' + _chalk2.default.cyan('$ now') + '\n\n  ' + _chalk2.default.gray('‚Äì') + ' Deploys a custom path ' + _chalk2.default.dim('`/usr/src/project`') + '\n\n    ' + _chalk2.default.cyan('$ now /usr/src/project') + '\n\n  ' + _chalk2.default.gray('‚Äì') + ' Deploys a GitHub repository\n\n    ' + _chalk2.default.cyan('$ now user/repo#ref') + '\n\n  ' + _chalk2.default.gray('‚Äì') + ' Deploys a GitHub, GitLab or Bitbucket repo using its URL\n\n    ' + _chalk2.default.cyan('$ now https://gitlab.com/user/repo') + '\n\n  ' + _chalk2.default.gray('‚Äì') + ' Deploys with ENV vars\n\n    ' + _chalk2.default.cyan('$ now -e NODE_ENV=production -e MYSQL_PASSWORD=@mysql-password') + '\n\n  ' + _chalk2.default.gray('‚Äì') + ' Displays comprehensive help for the subcommand ' + _chalk2.default.dim('`list`') + '\n\n    ' + _chalk2.default.cyan('$ now help list') + '\n');
};

var path = argv._[0];

if (path) {
  // if path is relative: resolve
  // if path is absolute: clear up strange `/` etc
  path = (0, _path.resolve)(process.cwd(), path);
} else {
  path = process.cwd();
}

// If the current deployment is a repo
var gitRepo = {};

var exit = function exit(code) {
  // we give stdout some time to flush out
  // because there's a node bug where
  // stdout writes are asynchronous
  // https://github.com/nodejs/node/issues/6456
  setTimeout(function () {
    return process.exit(code || 0);
  }, 100);
};

// options
var forceNew = argv.force;
var debug = argv.debug;
var clipboard = !argv['no-clipboard'];
var forwardNpm = argv['forward-npm'];
var forceSync = argv.forceSync;
var shouldLogin = argv.login;
var wantsPublic = argv.public;
var deploymentName = argv.name || false;
var apiUrl = argv.url || 'https://api.zeit.co';
var isTTY = process.stdout.isTTY;
var quiet = !isTTY;
var autoAlias = argv.alias || false;

if (argv.config) {
  cfg.setConfigFile(argv.config);
}

// Create a new deployment if user changed
// the name or made _src public.
// This should just work fine because it doesn't
// force a new sync, it just forces a new deployment.
if (deploymentName || wantsPublic) {
  forceNew = true;
}

var config = cfg.read();
var alwaysForwardNpm = config.forwardNpm;

if (argv.h || argv.help) {
  help();
  exit(0);
} else if (argv.v || argv.version) {
  console.log(_chalk2.default.bold('ùö´ now'), _package.version);
  process.exit(0);
} else if (!(argv.token || config.token) || shouldLogin) {
  (0, _login2.default)(apiUrl).then(function (token) {
    if (shouldLogin) {
      console.log('> Logged in successfully. Token saved in ~/.now.json');
      process.exit(0);
    } else {
      sync(token).catch(function (err) {
        (0, _error.error)('Unknown error: ' + err.stack);
        process.exit(1);
      });
    }
  }).catch(function (e) {
    (0, _error.error)('Authentication error \u2013 ' + e.message);
    process.exit(1);
  });
} else {
  sync(argv.token || config.token).catch(function (err) {
    (0, _error.error)('Unknown error: ' + err.stack);
    process.exit(1);
  });
}

var assignAlias = function () {
  var _ref12 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee6(token, deployment) {
    var type, aliases, list, related, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, alias, withID;

    return _regenerator2.default.wrap(function _callee6$(_context6) {
      while (1) {
        switch (_context6.prev = _context6.next) {
          case 0:
            type = _psl2.default.isValid(autoAlias) ? 'alias' : 'uid';
            aliases = new _alias2.default(apiUrl, token, { debug: debug });
            _context6.next = 4;
            return aliases.ls();

          case 4:
            list = _context6.sent;
            related = void 0;

            // Check if alias even exists

            _iteratorNormalCompletion = true;
            _didIteratorError = false;
            _iteratorError = undefined;
            _context6.prev = 9;
            _iterator = (0, _getIterator3.default)(list);

          case 11:
            if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
              _context6.next = 19;
              break;
            }

            alias = _step.value;

            if (!(alias[type] === autoAlias)) {
              _context6.next = 16;
              break;
            }

            related = alias;
            return _context6.abrupt('break', 19);

          case 16:
            _iteratorNormalCompletion = true;
            _context6.next = 11;
            break;

          case 19:
            _context6.next = 25;
            break;

          case 21:
            _context6.prev = 21;
            _context6.t0 = _context6['catch'](9);
            _didIteratorError = true;
            _iteratorError = _context6.t0;

          case 25:
            _context6.prev = 25;
            _context6.prev = 26;

            if (!_iteratorNormalCompletion && _iterator.return) {
              _iterator.return();
            }

          case 28:
            _context6.prev = 28;

            if (!_didIteratorError) {
              _context6.next = 31;
              break;
            }

            throw _iteratorError;

          case 31:
            return _context6.finish(28);

          case 32:
            return _context6.finish(25);

          case 33:
            if (related) {
              _context6.next = 37;
              break;
            }

            withID = type === 'uid' ? 'with ID ' : '';

            (0, _error.error)('Alias ' + withID + '"' + autoAlias + '" doesn\'t exist');
            return _context6.abrupt('return');

          case 37:

            console.log('> Assigning alias ' + _chalk2.default.bold.underline(related.alias) + ' to deployment...');

            // Assign alias
            _context6.next = 40;
            return aliases.set(String(deployment), String(related.alias));

          case 40:
          case 'end':
            return _context6.stop();
        }
      }
    }, _callee6, undefined, [[9, 21, 25, 33], [26,, 28, 32]]);
  }));

  return function assignAlias(_x4, _x5) {
    return _ref12.apply(this, arguments);
  };
}();

function printLogs(host, token) {
  var _this2 = this;

  // log build
  var logger = new _buildLogger2.default(host, { debug: debug, quiet: quiet });

  logger.on('close', (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee7() {
    return _regenerator2.default.wrap(function _callee7$(_context7) {
      while (1) {
        switch (_context7.prev = _context7.next) {
          case 0:
            if (!autoAlias) {
              _context7.next = 3;
              break;
            }

            _context7.next = 3;
            return assignAlias(token, host);

          case 3:

            if (!quiet) {
              console.log('' + _chalk2.default.cyan('> Deployment complete!'));
            }

            if (gitRepo && gitRepo.cleanup) {
              // Delete temporary directory that contains repository
              gitRepo.cleanup();

              if (debug) {
                console.log('> [debug] Removed temporary repo directory');
              }
            }

            process.exit(0);

          case 6:
          case 'end':
            return _context7.stop();
        }
      }
    }, _callee7, _this2);
  })));
}